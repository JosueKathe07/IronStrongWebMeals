<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IronStrong Fitness - Catálogo de Inspiración (TheMealDB)</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .meal-img { height: 180px; object-fit: cover; }
    .card-text { min-height: 72px; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body class="bg-light">

  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <span class="navbar-brand mb-0 h1">IronStrong Web - TheMealDB</span>
    </div>
  </nav>

  <main class="container py-4">

    <!-- Controles -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-5">
            <label class="form-label">Buscar recetas (GET)</label>
            <input id="txtSearch" type="text" class="form-control" placeholder="Ej: chicken, pasta, beef..." />
          </div>

          <div class="col-md-3">
            <label class="form-label">Filtrar por categoría (en memoria)</label>
            <select id="selCategory" class="form-select">
              <option value="ALL">Todas</option>
              <!-- se llena dinámicamente -->
            </select>
          </div>

          <div class="col-md-2 d-grid">
            <button id="btnSearch" class="btn btn-primary">Buscar</button>
          </div>

          <div class="col-md-2 d-grid">
            <button id="btnClear" class="btn btn-outline-secondary">Limpiar</button>
          </div>
        </div>

        <div class="mt-2 small text-muted">
          API: https://www.themealdb.com/api/json/v1/1/search.php?s=
        </div>
      </div>
    </div>

    <!-- Estado -->
    <div id="alertBox" class="alert d-none" role="alert"></div>

    <!-- Resultados -->
    <div id="results" class="row g-3"></div>

    <hr class="my-4" />

    <!-- POST Simulado -->
    <div class="card shadow-sm">
      <div class="card-header fw-semibold">Formulario de Sugerencias (POST simulado)</div>
      <div class="card-body">
        <form id="frmSuggest" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nombre de receta</label>
            <input name="recipeName" class="form-control" required placeholder="Mi receta saludable..." />
          </div>
          <div class="col-md-6">
            <label class="form-label">Tu correo</label>
            <input name="email" type="email" class="form-control" required placeholder="tucorreo@correo.com" />
          </div>
          <div class="col-12">
            <label class="form-label">Descripción</label>
            <textarea name="description" class="form-control" rows="3" required
              placeholder="Describe ingredientes y preparación..."></textarea>
          </div>
          <div class="col-12 d-grid d-md-flex gap-2">
            <button class="btn btn-success" type="submit">Enviar sugerencia</button>
            <span id="postStatus" class="align-self-center text-muted small"></span>
          </div>
        </form>

        <div class="mt-3">
          <div class="small text-muted">
            POST simulado usando ReqRes: https://reqres.in/api/users
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal "Agregar al Menú Local" -->
  <div class="modal fade" id="menuModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Agregar al Menú Local</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">Se simula que este platillo se envió a SQL. El JSON también se imprime en consola.</p>
          <pre id="jsonPreview" class="bg-light p-3 rounded border"></pre>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap + jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <script>
    // ===== Estado global en memoria =====
    let mealsCache = [];      // aquí guardamos el arreglo meals completo (sin recargar API)
    let categoriesCache = []; // categorías únicas para el <select>

    function showAlert(type, message) {
      const box = $("#alertBox");
      box.removeClass("d-none alert-success alert-danger alert-warning alert-info")
         .addClass("alert-" + type)
         .text(message);
    }

    function hideAlert() {
      $("#alertBox").addClass("d-none").text("");
    }

    function truncateText(text, max = 100) {
      if (!text) return "";
      return text.length > max ? text.substring(0, max) + "..." : text;
    }

    function normalizeCategory(cat) {
      return (cat && cat.trim().length) ? cat.trim() : "Sin categoría";
    }

    function fillCategorySelect() {
      const sel = $("#selCategory");
      sel.find("option:not([value='ALL'])").remove();

      categoriesCache = [...new Set(mealsCache.map(m => normalizeCategory(m.strCategory)))].sort();

      // Si quieres EXACTAMENTE Beef/Seafood/Pasta como el ejemplo del enunciado,
      // igual funciona: el filtro se hace en memoria.
      categoriesCache.forEach(cat => {
        sel.append(`<option value="${cat}">${cat}</option>`);
      });
    }

    function renderMeals(list) {
      const container = $("#results");
      container.empty();

      if (!list || list.length === 0) {
        container.append(`
          <div class="col-12">
            <div class="alert alert-warning mb-0">No hay resultados para mostrar.</div>
          </div>
        `);
        return;
      }

      list.forEach(meal => {
        const title = meal.strMeal || "Sin título";
        const category = normalizeCategory(meal.strCategory);
        const area = (meal.strArea && meal.strArea.trim()) ? meal.strArea : "Sin país";
        const img = meal.strMealThumb || "";
        const instructions = truncateText(meal.strInstructions, 100);

        container.append(`
          <div class="col-sm-6 col-lg-4">
            <div class="card h-100 shadow-sm">
              <img src="${img}" class="card-img-top meal-img" alt="${title}">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${title}</h5>
                <div class="mb-2">
                  <span class="badge text-bg-primary me-1">${category}</span>
                  <span class="badge text-bg-secondary">${area}</span>
                </div>
                <p class="card-text text-muted">${instructions}</p>

                <div class="mt-auto d-grid">
                  <button class="btn btn-outline-success btnAddMenu"
                          data-mealid="${meal.idMeal}">
                    Agregar al Menú Local
                  </button>
                </div>
              </div>
            </div>
          </div>
        `);
      });
    }

    function applyFilter() {
      const selected = $("#selCategory").val();
      if (selected === "ALL") {
        renderMeals(mealsCache);
        return;
      }
      const filtered = mealsCache.filter(m => normalizeCategory(m.strCategory) === selected);
      renderMeals(filtered);
    }

    async function fetchMeals(searchText) {
      hideAlert();

      const q = (searchText || "").trim();
      if (!q) {
        showAlert("warning", "Escribe un término de búsqueda (ej: chicken).");
        return;
      }

      showAlert("info", "Buscando recetas...");

      try {
        const url = "https://www.themealdb.com/api/json/v1/1/search.php?s=" + encodeURIComponent(q);

        // GET con jQuery
        const data = await $.getJSON(url);

        // Reto JSON: manejar { "meals": [...] } (o null)
        if (!data || !data.meals) {
          mealsCache = [];
          fillCategorySelect();
          renderMeals([]);
          showAlert("warning", "No se encontraron recetas.");
          return;
        }

        mealsCache = data.meals;
        fillCategorySelect();
        renderMeals(mealsCache);
        showAlert("success", `Resultados encontrados: ${mealsCache.length}`);

      } catch (err) {
        console.error(err);
        showAlert("danger", "Error consultando TheMealDB. Revisa tu conexión o intenta de nuevo.");
      }
    }

    // ===== Eventos =====
    $("#btnSearch").on("click", () => fetchMeals($("#txtSearch").val()));

    $("#txtSearch").on("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        fetchMeals($("#txtSearch").val());
      }
    });

    $("#btnClear").on("click", () => {
      $("#txtSearch").val("");
      $("#selCategory").val("ALL");
      mealsCache = [];
      fillCategorySelect();
      renderMeals([]);
      hideAlert();
    });

    $("#selCategory").on("change", applyFilter);

    // Delegación para botones dinámicos
    $(document).on("click", ".btnAddMenu", function () {
      const id = $(this).data("mealid");
      const meal = mealsCache.find(m => m.idMeal == id);

      if (!meal) {
        alert("No se encontró el platillo en memoria.");
        return;
      }

      // Evidencia: mostrar JSON en consola
      console.log("Platillo seleccionado (simulación import a SQL):", meal);

      // Mostrar modal con JSON formateado
      $("#jsonPreview").text(JSON.stringify(meal, null, 2));
      const modal = new bootstrap.Modal(document.getElementById("menuModal"));
      modal.show();
    });

    // POST simulado con ReqRes
    $("#frmSuggest").on("submit", async function (e) {
      e.preventDefault();
      $("#postStatus").text("Enviando...");

      const payload = {
        recipeName: this.recipeName.value,
        email: this.email.value,
        description: this.description.value,
        createdAt: new Date().toISOString()
      };

      try {
        const response = await $.ajax({
          url: "https://reqres.in/api/users",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(payload)
        });

        console.log("Respuesta POST simulado:", response);
        $("#postStatus").text("✅ Enviado correctamente (ver consola).");
        showAlert("success", "Sugerencia enviada (POST simulado). Revisa consola para evidencia.");

        this.reset();

      } catch (err) {
        console.error(err);
        $("#postStatus").text("❌ Error al enviar.");
        showAlert("danger", "Falló el POST simulado. Intenta de nuevo.");
      }
    });

    // Render inicial vacío
    renderMeals([]);
  </script>
</body>
</html>
